<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calculate correlations and correlation tables with complex survey data • jtools</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Lato-0.4.9/font.css" rel="stylesheet">
<link href="../deps/IBM_Plex_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Raleway-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Calculate correlations and correlation tables with complex survey data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">jtools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper-o"></span> News</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-code-o"></span> Documentation</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-book"></span> Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/summ.html">Tools for summarizing and visualizing regression models</a></li>
    <li><a class="dropdown-item" href="../articles/effect_plot.html">Visualizing regression model predictions</a></li>
    <li><a class="dropdown-item" href="../articles/svycor.html">Calculate correlations and correlation tables with complex survey data</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jacob-long/jtools"><span class="fa fa-github fa-lg"></span> Github</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Calculate correlations and correlation tables with complex survey data</h1>
                        <h4 data-toc-skip class="author">Jacob Long</h4>
            
            <h4 data-toc-skip class="date">2024-08-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jacob-long/jtools/blob/master/vignettes/svycor.Rmd" class="external-link"><code>vignettes/svycor.Rmd</code></a></small>
      <div class="d-none name"><code>svycor.Rmd</code></div>
    </div>

    
    
<p>The <code>survey</code> package is one of R’s best tools for those
working in the social sciences. For many, it saves you from needing to
use commercial software for research that uses survey data. However, it
lacks one function that many academic researchers often need to report
in publications: correlations. The <code>svycor</code> function in
<code>jtools</code> helps to fill that gap.</p>
<p>A note, however, is necessary. The initial motivation to add this
feature comes from a <a href="https://stackoverflow.com/questions/34418822/pearson-correlation-coefficient-in-rs-survey-package#41031088" class="external-link">response
to a question</a> about calculating correlations with the
<code>survey</code> package written by Thomas Lumley, the
<code>survey</code> package author. All that is good about this function
should be attributed to Dr. Lumley; all that is wrong with it should be
attributed to me (Jacob).</p>
<p>With that said, let’s look at an example. First, we need to get a
<code>survey.design</code> object. This one is built into the
<code>survey</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">api</span><span class="op">)</span></span>
<span><span class="va">dstrat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,strata <span class="op">=</span> <span class="op">~</span><span class="va">stype</span>, weights <span class="op">=</span> <span class="op">~</span><span class="va">pw</span>, data <span class="op">=</span> <span class="va">apistrat</span>, fpc<span class="op">=</span><span class="op">~</span><span class="va">fpc</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="basic-use">Basic use<a class="anchor" aria-label="anchor" href="#basic-use"></a>
</h2>
<p>The necessary arguments are no different than when using
<code>svyvar</code>. Specify, using an equation, which variables (and
from which design) to include. It doesn’t matter which side of the
equation the variables are on.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/svycor.html">svycor</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span> <span class="op">+</span> <span class="va">api99</span>, design <span class="op">=</span> <span class="va">dstrat</span><span class="op">)</span></span></code></pre></div>
<pre><code>      api00 api99
api00  1.00  0.98
api99  0.98  1.00</code></pre>
<p>You can specify with the <code>digits =</code> argument how many
digits past the decimal point should be printed.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/svycor.html">svycor</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span> <span class="op">+</span> <span class="va">api99</span>, design <span class="op">=</span> <span class="va">dstrat</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code>       api00  api99
api00 1.0000 0.9759
api99 0.9759 1.0000</code></pre>
<p>Any other arguments that you would normally pass to
<code>svyvar</code> will be used as well, though in some cases it may
not affect the output.</p>
</div>
<div class="section level2">
<h2 id="statistical-significance-tests">Statistical significance tests<a class="anchor" aria-label="anchor" href="#statistical-significance-tests"></a>
</h2>
<p>One thing that <code>survey</code> won’t do for you is give you
<em>p</em> values for the null hypothesis that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">r = 0</annotation></semantics></math>.
While at first blush finding the <em>p</em> value might seem like a
simple procedure, complex surveys will almost always violate the
important distributional assumptions that go along with simple
hypothesis tests of the correlation coefficient. There is not a clear
consensus on the appropriate way to conduct hypothesis tests in this
context, due in part to the fact that most analyses of complex surveys
occurs in the context of multiple regression rather than simple
bivariate cases.</p>
<p>If <code>sig.stats = TRUE</code>, then <code>svycor</code> will use
the <code>wtd.cor</code> function from the <code>weights</code> package
to conduct hypothesis tests. The <em>p</em> values are derived from a
bootstrap procedure in which the weights define sampling probability.
The <code>bootn =</code> argument is given to <code>wtd.cor</code> to
define the number of simulations to run. This can significantly increase
the running time for large samples and/or large numbers of simulations.
The <code>mean1</code> argument tells <code>wtd.cor</code> whether it
should treat your sample size as the number of observations in the
survey design (the number of rows in the data frame) or the sum of the
weights. Usually, the former is desired, so the default value of
<code>mean1</code> is <code>TRUE</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/svycor.html">svycor</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span> <span class="op">+</span> <span class="va">api99</span>, design <span class="op">=</span> <span class="va">dstrat</span>, digits <span class="op">=</span> <span class="fl">4</span>, sig.stats <span class="op">=</span> <span class="cn">TRUE</span>, bootn <span class="op">=</span> <span class="fl">2000</span>, mean1 <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>      api00   api99  
api00 1       0.9759*
api99 0.9759* 1      </code></pre>
<p>When using <code>sig.stats = TRUE</code>, the correlation parameter
estimates come from the bootstrap procedure rather than the simpler
method based on the survey-weighted covariance matrix when
<code>sig.stats = FALSE</code>.</p>
<p>By saving the output of the function, you can extract non-rounded
coefficients, <em>p</em> values, and standard errors.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/svycor.html">svycor</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span> <span class="op">+</span> <span class="va">api99</span>, design <span class="op">=</span> <span class="va">dstrat</span>, digits <span class="op">=</span> <span class="fl">4</span>, sig.stats <span class="op">=</span> <span class="cn">TRUE</span>, bootn <span class="op">=</span> <span class="fl">2000</span>, mean1 <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c</span><span class="op">$</span><span class="va">cors</span></span></code></pre></div>
<pre><code>          api00     api99
api00 1.0000000 0.9759047
api99 0.9759047 1.0000000</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c</span><span class="op">$</span><span class="va">p.values</span></span></code></pre></div>
<pre><code>      api00 api99
api00     0     0
api99     0     0</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c</span><span class="op">$</span><span class="va">std.err</span></span></code></pre></div>
<pre><code>            api00       api99
api00 0.000000000 0.003471507
api99 0.003471507 0.000000000</code></pre>
</div>
<div class="section level2">
<h2 id="technical-details">Technical details<a class="anchor" aria-label="anchor" href="#technical-details"></a>
</h2>
<p>The heavy lifting behind the scenes is done by <code>svyvar</code>,
which from its output you may not realize also calculates
covariance.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svyvar</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span> <span class="op">+</span> <span class="va">api99</span>, design <span class="op">=</span> <span class="va">dstrat</span><span class="op">)</span></span></code></pre></div>
<pre><code>      variance     SE
api00    15191 1255.7
api99    16518 1318.4</code></pre>
<p>But if you save the <code>svyvar</code> object, you can see that
there’s more than meets the eye.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svyvar</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span> <span class="op">+</span> <span class="va">api99</span>, design <span class="op">=</span> <span class="va">dstrat</span><span class="op">)</span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SparseM/man/SparseM.ontology.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="va">var</span></span></code></pre></div>
<pre><code>         api00    api99
api00 15190.59 15458.83
api99 15458.83 16518.24
attr(,"var")
        api00   api00   api99   api99
api00 1576883 1580654 1580654 1561998
api00 1580654 1630856 1630856 1657352
api99 1580654 1630856 1630856 1657352
api99 1561998 1657352 1657352 1738266
attr(,"statistic")
[1] "variance"</code></pre>
<p>Once we know that, it’s just a matter of using R’s
<code>cov2cor</code> function and cleaning up the output.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="va">cor</span></span></code></pre></div>
<pre><code>          api00     api99
api00 1.0000000 0.9759047
api99 0.9759047 1.0000000
attr(,"var")
        api00   api00   api99   api99
api00 1576883 1580654 1580654 1561998
api00 1580654 1630856 1630856 1657352
api99 1580654 1630856 1630856 1657352
api99 1561998 1657352 1657352 1738266
attr(,"statistic")
[1] "variance"</code></pre>
<p>Now to get rid of that covariance matrix…</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cor</span> <span class="op">&lt;-</span> <span class="va">cor</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cor</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cor</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">cor</span></span></code></pre></div>
<pre><code>          api00     api99
api00 1.0000000 0.9759047
api99 0.9759047 1.0000000</code></pre>
<p><code>svycor</code> has its own print method, so you won’t see so
many digits past the decimal point. You can extract the un-rounded
matrix, however.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/svycor.html">svycor</a></span><span class="op">(</span><span class="op">~</span><span class="va">api99</span> <span class="op">+</span> <span class="va">api00</span>, design <span class="op">=</span> <span class="va">dstrat</span><span class="op">)</span></span>
<span><span class="va">out</span><span class="op">$</span><span class="va">cors</span></span></code></pre></div>
<pre><code>          api99     api00
api99 1.0000000 0.9759047
api00 0.9759047 1.0000000</code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jacob A. Long.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
